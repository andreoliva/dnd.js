/** DND Version 1.0
Developed by: Andr√© H. Oliva
Copyright 2014
*/
window.dnd=function(){function DND(e){for(var t=0;t<e.length;t++)this[t]=e[t]
this.length=e.length}function CheckTouchTarget(e){var t=document.elementFromPoint(e.changedTouches[0].clientX,e.changedTouches[0].clientY);(t.hasAttribute("data-drag-id")||t.hasAttribute("data-drag-child"))&&t.className.search("cloned-piece")==-1&&(e.preventDefault(),t=null===t.getAttribute("data-drag-id")?findDraggableParent(t):t,configs[t.getAttribute("data-drag-id")].clone?CreateClone(e):Grab(e))}function CreateClone(e){if(e.preventDefault(),"touchstart"==e.type&&(e=e.touches[0]),"BUTTON"==e.target.tagName)return!0
var evtTarget=null==e.target.getAttribute("data-drag-id")?findDraggableParent(e.target):e.target
if(eval(evtTarget.getAttribute("data-drag-disabled")))return!1
currentData=configs[evtTarget.getAttribute("data-drag-id")],currentData.originalElement=evtTarget,currentData.originalElement.setAttribute("data-drag-disabled",!0)
var clone=evtTarget.cloneNode(!0)
clone.className+=clone.className?" cloned-piece":"cloned-piece",clone.style.position="absolute",currentData.parent.appendChild(clone),currentData.dragElement=clone,currentData.onStart&&currentData.onStart(e)
var bcr=evtTarget.getBoundingClientRect(),pos={top:bcr.top/scale,left:bcr.left/scale}
if(bcr=currentData.parent.getBoundingClientRect(),pos.top-=bcr.top/scale,pos.left-=bcr.left/scale,currentData.centralize){var cs=window.getComputedStyle(currentData.dragElement),centerX=parseInt(cs.width)/2,centerY=parseInt(cs.height)/2
currentData.grabPoint.x=pos.left+centerX,currentData.grabPoint.y=pos.top+centerY,centerX=-pos.left+(e.clientX/scale-centerX),centerY=-pos.top+(e.clientY/scale-centerY),setCSSTransform(clone,"translate("+centerX+"px,"+centerY+"px)")}clone.style.top=pos.top+"px",clone.style.left=pos.left+"px",clone.style.margin="0px",evtTarget.style.opacity=0,Grab(e,clone)}function Grab(e,t){if(e.preventDefault(),"touchstart"==e.type&&(e=e.touches[0]),"BUTTON"==e.target.tagName)return!0
var r=null==e.target.getAttribute("data-drag-id")?findDraggableParent(e.target):e.target
currentData=configs[r.getAttribute("data-drag-id")],currentData.originalCoords={x:r.getBoundingClientRect().left,y:r.getBoundingClientRect().top},currentData.dragElement=t||r,currentData.dragElement.style.zIndex=1e7,currentData.x=currentData.y=0,!currentData.clone&&currentData.onStart&&currentData.onStart(e),currentData.grabPoint.x=currentData.grabPoint.x||e.clientX/scale,currentData.grabPoint.y=currentData.grabPoint.y||e.clientY/scale,document.addEventListener("mouseup",Drop),document.addEventListener("mousemove",Drag),document.body.addEventListener("touchmove",Drag)}function Drag(e){e.preventDefault(),"touchmove"==e.type&&(e=e.changedTouches[0]),currentData.x=e.clientX/scale-currentData.grabPoint.x,currentData.y=e.clientY/scale-currentData.grabPoint.y,currentData.y+=0==currentData.y?.001:0,setCSSTransform(currentData.dragElement,"translate("+currentData.x+"px,"+currentData.y+"px)"),currentData.onDrag&&currentData.onDrag(e)}function Drop(e){return!(!currentData||!currentData.dragElement)&&(e.preventDefault(),"touchend"==e.type&&(e=e.changedTouches[0]),document.removeEventListener("mousemove",Drag),document.removeEventListener("mouseup",Drop),document.body.removeEventListener("touchmove",Drag),currentData.dragElement.style.display="none",currentData.dropTarget=document.elementFromPoint(e.clientX,e.clientY),currentData.dragElement.style.display="block",currentData.grabPoint={},currentData.dropTarget==currentData.originalElement&&(currentData.dropTarget=currentData.originalElement.parentNode),currentData.onDrop&&currentData.onDrop(e)?void(currentData=null):(currentData.revert>=0?RevertDrag(currentData):PlaceDrag(currentData),void(currentData=null)))}function RevertDrag(e,t){if(!e.dragElement||e.reverting)return!1
e.reverting=!0,e.revertCallback=t
var r=e.revert/20,n=e.y/e.x,a=e.x/r
e.revertInterval=setInterval(function(){if(r<=0)return setCSSTransform(e.dragElement,"translate(0px,0px)"),clearInterval(e.revertInterval),void TransitionEnd(e)
r--
var t=a*r,o=t*n
setCSSTransform(e.dragElement,"translate("+t+"px, "+o+"px)")},10)}function TransitionEnd(e){e.clone?(e.dragElement.parentNode.removeChild(e.dragElement),e.dragElement=null,e.originalElement.style.opacity=1,e.originalElement.removeAttribute("data-drag-disabled")):e.originalElement.style.removeProperty("z-index"),e.revertCallback&&e.revertCallback(),delete e.reverting}function PlaceDrag(e,t){var r={x:e.dragElement.style.transform?parseInt(e.dragElement.style.transform.split("(").pop().split(",")[0])*scale:0,y:e.dragElement.style.transform?parseInt(e.dragElement.style.transform.split("(").pop().split(",")[1])*scale:0},n=window.getComputedStyle(e.dropTarget,null),a=n.getPropertyValue("-webkit-transform")||n.getPropertyValue("-moz-transform")||n.getPropertyValue("-ms-transform")||n.getPropertyValue("-o-transform")||n.getPropertyValue("transform")||1
"static"==n.getPropertyValue("position")&&(e.dropTarget.style.position="relative"),a="none"==a?1:parseFloat(a.split("(")[1].split(",")[0]),setCSSTransform(e.dragElement,"translate(0px,0px)"),e.dragElement.style.position="absolute",e.dragElement.style.margin="0",e.dragElement.style.top=(e.originalCoords.y+r.y-e.dropTarget.getBoundingClientRect().top)/a/scale+"px",e.dragElement.style.left=(e.originalCoords.x+r.x-e.dropTarget.getBoundingClientRect().left)/a/scale+"px",e.dropTarget.appendChild(e.dragElement),e.clone&&(e.dragElement.addEventListener("mousedown",CreateClone),e.dragElement.className=e.originalElement.className,e.originalElement.parentNode.removeChild(e.originalElement)),t&&t()}function findDraggableParent(e){for(;null==e.getAttribute("data-drag-id");)e=e.parentNode
return e}function setCSSTransform(e,t){return!!e&&(e.style.transform=t,e.style.webkitTransform=t,e.style.mozTransform=t,e.style.msTransform=t,void(e.style.oTransform=t))}var currentData,scale=1,configs={},dndCount=0
DND.prototype.map=function(e){for(var t=[],r=0;r<this.length;r++)t.push(e.call(this,this[r],r))
return t},DND.prototype.forEach=function(e){return this.map(e),this},DND.prototype.initDraggable=function(e){return e=e||{},this.map(function(t){configs[dndCount]={onStart:"undefined"!=typeof e.onStart?e.onStart:null,onDrag:"undefined"!=typeof e.onDrag?e.onDrag:null,onDrop:"undefined"!=typeof e.onDrop?e.onDrop:null,parent:"undefined"!=typeof e.parent?e.parent:document.body,centralize:"undefined"!=typeof e.centralize&&e.centralize,clone:"undefined"!=typeof e.clone&&e.clone,revert:"undefined"!=typeof e.revert?e.revert:-1,originalElement:t,originalCoords:{},grabPoint:{},dragElement:null,dropTarget:null},e.onCreate&&e.onCreate(),t.setAttribute("data-drag-id",dndCount)
for(var r=t.getElementsByTagName("*"),n=0;n<r.length;n++)r[n].setAttribute("data-drag-child",!0)
t.addEventListener("mousedown",e.clone?CreateClone:Grab),document.body.addEventListener("touchstart",CheckTouchTarget),document.body.addEventListener("touchend",Drop),dndCount++})},DND.prototype.removeDraggable=function(){return this.map(function(e){e.removeEventListener("mousedown",CreateClone),e.removeEventListener("mousedown",Grab),delete configs[e.getAttribute("data-drag-id")],e.removeAttribute("data-drag-id")})},DND.prototype.option=function(e,t){return this.map(function(r){var n=r.getAttribute("data-drag-id")
configs[n][e]=t}),this},DND.prototype.destroyElement=function(){return this.map(function(e){var t=e.getAttribute("data-drag-id")
if(null!==t){var r=configs[t]
delete configs[t],r.dragElement!==r.originalElement&&null!==r.dragElement?(r.originalElement.parentNode&&r.originalElement.parentNode.removeChild(r.originalElement),r.dragElement.parentNode&&r.dragElement.parentNode.removeChild(r.dragElement)):r.originalElement.parentNode&&r.originalElement.parentNode.removeChild(r.originalElement)}else e.parentNode.removeChild(e)})}
var dnd={get:function(e){var t
return t="string"==typeof e?document.querySelectorAll(e):e.length?e:[e],new DND(t)},setScale:function(e){scale=e},revertDrag:function(e,t){RevertDrag(e,t)},placeDrag:function(e,t){PlaceDrag(e,t)},getParentScale:function(e){var t=window.getComputedStyle(e.parentNode,null),r=t.getPropertyValue("-webkit-transform")||t.getPropertyValue("-moz-transform")||t.getPropertyValue("-ms-transform")||t.getPropertyValue("-o-transform")||t.getPropertyValue("transform")||"none"
return"none"==r?1:parseFloat(r.split("(")[1].split(",")[0])}}
return dnd}()
